# 测试文档

## 测试规范和最佳实践

### 1. 测试结构规范

- 测试文件命名：`test_<module_name>.py`
- 测试类命名：`Test<ModuleName>`
- 测试方法命名：`test_<scenario_description>`

### 2. 测试组织结构

每个测试文件应包含：
- 模块级文档字符串，说明测试内容
- 必要的导入语句
- 测试数据和固定装置（fixtures）
- 按功能组织的测试类
- 清晰的测试方法注释

### 3. 测试用例编写规范

- 每个测试方法必须有清晰的文档字符串
- 使用统一的响应格式验证
- 使用统一的错误消息（来自 error_messages.py）
- 合理使用 pytest fixtures
- 保持测试数据的独立性

### 4. 响应格式规范

所有API响应必须遵循统一格式：
```python
{
    "code": int,      # 0表示成功，非0表示错误
    "message": str,   # 响应消息
    "data": Any       # 响应数据，错误时为None
}
```

### 5. 测试数据管理

- 使用工厂模式创建测试数据
- 每个测试方法执行后清理数据
- 避免测试间数据依赖
- 使用合适的测试数据范围

### 6. 错误处理规范

- 验证错误响应的完整性
- 检查错误码的正确性
- 确保错误消息使用统一语言
- 验证错误时data字段为None

### 7. 测试覆盖率要求

- 单元测试覆盖率 >= 80%
- 集成测试覆盖率 >= 60%
- 关键功能覆盖率 = 100%

## 运行测试

```bash
# 运行所有测试
pytest

# 运行特定模块测试
pytest tests/test_auth.py

# 运行带标记的测试
pytest -m "slow"

# 生成覆盖率报告
pytest --cov=app tests/
```

## 常见问题

1. 测试数据清理失败
   - 检查 setup/teardown 方法
   - 确认数据库回滚正常

2. 测试执行超时
   - 检查数据库连接
   - 排查无限循环

3. 测试结果不稳定
   - 检查测试数据独立性
   - 确认并发处理正确

## HTTP 状态码规范

1. 成功响应
   - GET: 200 OK
   - POST: 201 Created
   - PUT: 200 OK
   - DELETE: 204 No Content

2. 错误响应
   - 400 Bad Request: 请求参数错误
   - 401 Unauthorized: 未认证
   - 403 Forbidden: 权限不足
   - 404 Not Found: 资源不存在
   - 422 Unprocessable Entity: 数据验证失败
   - 500 Internal Server Error: 服务器错误

## 响应格式规范

1. 成功响应格式
   ```json
   {
     "code": 200,
     "message": "操作成功",
     "data": {}
   }
   ```

2. 错误响应格式
   ```json
   {
     "code": 400,
     "message": "错误信息",
     "data": null
   }
   ```

## 测试覆盖率要求

1. 总体要求
   - 代码覆盖率不低于 80%
   - 核心业务逻辑覆盖率不低于 90%

2. 必须测试的场景
   - 正常流程
   - 异常流程
   - 边界条件
   - 权限控制

## 最佳实践

1. 使用 pytest fixtures
   - 合理使用 fixture 共享测试资源
   - 使用 conftest.py 管理全局 fixtures

2. 参数化测试
   - 使用 @pytest.mark.parametrize 处理多个测试用例
   - 使用清晰的参数名称和测试数据

3. 异步测试
   - 仅在测试异步函数时使用 @pytest.mark.asyncio
   - 同步测试不要使用异步标记

4. 测试隔离
   - 每个测试应该是独立的
   - 避免测试间的状态共享
   - 使用事务回滚保持数据库清洁

5. 错误处理
   - 测试异常情况
   - 验证错误响应格式
   - 确保错误信息明确有用

6. 性能考虑
   - 避免不必要的数据库操作
   - 合理使用测试数据量
   - 注意测试执行时间 